
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="holmes">
      
      
      
        <link rel="prev" href="../fyne_tick/">
      
      
        <link rel="next" href="../godot_pitaya_proto/">
      
      
        
      
      
      <link rel="icon" href="../../assets/logo_r.png">
      <meta name="generator" content="zensical-0.0.24">
    
    
      
        <title>Godot pitaya - holmes blog</title>
      
    
    
      
        
      
      <link rel="stylesheet" href="../../assets/stylesheets/classic/main.d9d44b50.min.css">
      
        
          
        
        <link rel="stylesheet" href="../../assets/stylesheets/classic/palette.7dc9a0ad.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,t)=>(e<<5)-e+t.charCodeAt(0)),0),__md_get=(e,t=localStorage,a=__md_scope)=>JSON.parse(t.getItem(a.pathname+"."+e)),__md_set=(e,t,a=localStorage,_=__md_scope)=>{try{a.setItem(_.pathname+"."+e,JSON.stringify(t))}catch(e){}},document.documentElement.setAttribute("data-platform",navigator.platform)</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#godot-pitaya" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="holmes blog" class="md-header__button md-logo" aria-label="holmes blog" data-md-component="logo">
      
  <img src="../../assets/logo_r.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            holmes blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Godot pitaya
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-moon" viewBox="0 0 24 24"><path d="M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog" aria-label="查找">
  <button type="button" class="md-search__button">
    查找
  </button>
</div>
      
    
    <div class="md-header__source">
      
        <a href="https://github.com/hcqmaker" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      
    </div>
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="holmes blog" class="md-nav__button md-logo" aria-label="holmes blog" data-md-component="logo">
      
  <img src="../../assets/logo_r.png" alt="logo">

    </a>
    holmes blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hcqmaker" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../blog/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    
  
    博客
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    程序笔记
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    程序笔记
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fyne_tick/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    fyne的超时计时器钟表实现
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    godot连接pitaya
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="././" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    godot连接pitaya
  

    
  </span>
  
  

      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#godot-pitaya" class="md-nav__link">
    <span class="md-ellipsis">
      
        godot 连接 pitaya
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="godot 连接 pitaya">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        原由：
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="原由：">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        在选择游戏服务器框架的时候想到了一些东西
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="在选择游戏服务器框架的时候想到了一些东西">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#go" class="md-nav__link">
    <span class="md-ellipsis">
      
        最终选择go语言
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        框架选择方面
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="框架选择方面">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pitaya" class="md-nav__link">
    <span class="md-ellipsis">
      
        暂时选择pitaya
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#godot" class="md-nav__link">
    <span class="md-ellipsis">
      
        客户端 选择godot 因为开源，整体使用还不错
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        开始正题
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="开始正题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        服务器部分
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="服务器部分">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maingo" class="md-nav__link">
    <span class="md-ellipsis">
      
        main.go
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        客户端部分
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="客户端部分">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      
        客户端代码设计3个脚本
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maingd" class="md-nav__link">
    <span class="md-ellipsis">
      
        main.gd
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streamtcpgd" class="md-nav__link">
    <span class="md-ellipsis">
      
        StreamTCP.gd
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clientgd" class="md-nav__link">
    <span class="md-ellipsis">
      
        client.gd
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../godot_pitaya_proto/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    godot链接pitaya结合proto
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    穴位图
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../other/ziwuliuzhu_sz.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    子午流注时钟
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    关于
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../license/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    许可
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#godot-pitaya" class="md-nav__link">
    <span class="md-ellipsis">
      
        godot 连接 pitaya
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="godot 连接 pitaya">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        原由：
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="原由：">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        在选择游戏服务器框架的时候想到了一些东西
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="在选择游戏服务器框架的时候想到了一些东西">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#go" class="md-nav__link">
    <span class="md-ellipsis">
      
        最终选择go语言
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        框架选择方面
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="框架选择方面">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pitaya" class="md-nav__link">
    <span class="md-ellipsis">
      
        暂时选择pitaya
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#godot" class="md-nav__link">
    <span class="md-ellipsis">
      
        客户端 选择godot 因为开源，整体使用还不错
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        开始正题
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="开始正题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        服务器部分
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="服务器部分">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maingo" class="md-nav__link">
    <span class="md-ellipsis">
      
        main.go
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        客户端部分
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="客户端部分">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      
        客户端代码设计3个脚本
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maingd" class="md-nav__link">
    <span class="md-ellipsis">
      
        main.gd
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streamtcpgd" class="md-nav__link">
    <span class="md-ellipsis">
      
        StreamTCP.gd
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clientgd" class="md-nav__link">
    <span class="md-ellipsis">
      
        client.gd
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


  <nav class="md-path" aria-label="导航栏" >
    <ol class="md-path__list">
      
        
  
  
    <li class="md-path__item">
      <a href="../.." class="md-path__link">
        
  <span class="md-ellipsis">
    Home
  </span>

      </a>
    </li>
  

      
      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../fyne_tick/" class="md-path__link">
          
  <span class="md-ellipsis">
    程序笔记
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  
  
  


  <h1>Godot pitaya</h1>

<h2 id="godot-pitaya">godot 连接 pitaya<a class="headerlink" href="#godot-pitaya" title="Permanent link">&para;</a></h2>
<h3 id="_1">原由：<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<h5 id="_2">在选择游戏服务器框架的时候想到了一些东西<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h5>
<ul>
<li>
<ol>
<li>首先是 分布式，原因是大部分情况想需要部署不同的东西到不同的服务器，比如**数据库**，<strong>登录服务器</strong>，<strong>游戏服务器</strong>,<strong>活动</strong>，在不同需求的试试，可能添加各种东西，那么分布式一个考虑的选项</li>
</ol>
</li>
<li>
<ol>
<li>语言的选择上，<strong>Java</strong>,<strong>C++</strong>,<strong>C#</strong>,<strong>erlang</strong>,<strong>python</strong>,<strong>go</strong>,等等，<blockquote>
<p><strong>Java</strong>: 
  优：很稳定，需要jdk，
  劣：写代码那个大呀
<strong>C++</strong>:
  优：性能高
  劣：容易bug，崩溃，要求高，编译起来麻烦
<strong>c#</strong>: 优劣和java类似，写代码是一件很痛苦的事情
<strong>erlang</strong>: 专门为服务器设计的，但是我没怎么接触，被搁置了
<strong>python</strong>: 脚本语言，还好，其实还是个人，那语法，缩进，我一直接的很崩溃，找尾部中间加代码，也是几个体力活，都无语了都
<strong>go</strong>: 
  优：为服务器设计，编译快，稳定还不错
  劣：需要熟悉整体</p>
</blockquote>
</li>
</ol>
</li>
<li>
<ol>
<li>跨平台，部署方面以及环境搭建方面，</li>
</ol>
</li>
</ul>
<h6 id="go">最终选择go语言<a class="headerlink" href="#go" title="Permanent link">&para;</a></h6>
<h5 id="_3">框架选择方面<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h5>
<ul>
<li>
<ol>
<li><strong>安装简单</strong> 安装起来却这却那的，linux太常见了，折磨</li>
</ol>
</li>
<li>
<ol>
<li><strong>分布式</strong> 我自己在造轮子，写起来类</li>
</ol>
</li>
<li>
<ol>
<li><strong>有在更新</strong> 技术更新快，没有更新可能都有可能淘汰了</li>
</ol>
</li>
</ul>
<h6 id="pitaya">暂时选择pitaya<a class="headerlink" href="#pitaya" title="Permanent link">&para;</a></h6>
<ul>
<li>有在更新</li>
<li>他们有在使用框架</li>
<li>写起来也还算不难</li>
</ul>
<h5 id="godot">客户端 选择godot 因为开源，整体使用还不错<a class="headerlink" href="#godot" title="Permanent link">&para;</a></h5>
<ul>
<li><strong>unity</strong> 没钱，加各种登录，各种作妖</li>
<li><strong>ue</strong>  太大了，我笔记本玩不转，有点牛刀戳蚂蚁的感觉</li>
</ul>
<h3 id="_4">开始正题<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>**版本选择
- godot 4.6
- pitaya v2@2.11.21
- 客户端和服务器项目 上传到github
<a href="https://github.com/hcqmaker/sharething/blob/master/godot_pitaya.7z">godot_pitaya.7z</a>
不想下载，可以直接下面看代码</p>
<h4 id="_5">服务器部分<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p><strong>服务器参考的是demo chat</strong></p>
<h6 id="maingo">main.go<a class="headerlink" href="#maingo" title="Permanent link">&para;</a></h6>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;context&quot;</span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span>
<span class="w">    </span><span class="s">&quot;strconv&quot;</span>
<span class="w">    </span><span class="s">&quot;time&quot;</span>

<span class="w">    </span><span class="s">&quot;github.com/topfreegames/pitaya/v2/groups&quot;</span>

<span class="w">    </span><span class="s">&quot;strings&quot;</span>

<span class="w">    </span><span class="s">&quot;github.com/topfreegames/pitaya/v2&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/topfreegames/pitaya/v2/acceptor&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/topfreegames/pitaya/v2/component&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/topfreegames/pitaya/v2/config&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/topfreegames/pitaya/v2/logger&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/topfreegames/pitaya/v2/timer&quot;</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">Room</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">component</span><span class="p">.</span><span class="nx">Base</span>
<span class="w">        </span><span class="nx">timer</span><span class="w"> </span><span class="o">*</span><span class="nx">timer</span><span class="p">.</span><span class="nx">Timer</span>
<span class="w">        </span><span class="nx">app</span><span class="w">   </span><span class="nx">pitaya</span><span class="p">.</span><span class="nx">Pitaya</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">UserMessage</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">Name</span><span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;name&quot;`</span>
<span class="w">        </span><span class="nx">Content</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;content&quot;`</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">NewUser</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">Content</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;content&quot;`</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">AllMembers</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">Members</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;members&quot;`</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">JoinResponse</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">Code</span><span class="w">   </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;code&quot;`</span>
<span class="w">        </span><span class="nx">Result</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;result&quot;`</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">NewRoom</span><span class="p">(</span><span class="nx">app</span><span class="w"> </span><span class="nx">pitaya</span><span class="p">.</span><span class="nx">Pitaya</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">Room</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Room</span><span class="p">{</span>
<span class="w">        </span><span class="nx">app</span><span class="p">:</span><span class="w"> </span><span class="nx">app</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">Room</span><span class="p">)</span><span class="w"> </span><span class="nx">AfterInit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">r</span><span class="p">.</span><span class="nx">timer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">pitaya</span><span class="p">.</span><span class="nx">NewTimer</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">count</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">GroupCountMembers</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;room&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nx">logger</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nx">Debugf</span><span class="p">(</span><span class="s">&quot;UserCount: Time=&gt; %s, Count=&gt; %d, Error=&gt; %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">String</span><span class="p">(),</span><span class="w"> </span><span class="nx">count</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">Room</span><span class="p">)</span><span class="w"> </span><span class="nx">Join</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">JoinResponse</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nx">s</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">GetSessionFromCtx</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="w">    </span><span class="nx">fakeUID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">ID</span><span class="p">()</span><span class="w">                              </span><span class="c1">// just use s.ID as uid !!!</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Bind</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">fakeUID</span><span class="p">)))</span><span class="w"> </span><span class="c1">// binding session uid</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">pitaya</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;RH-000&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;failed&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bind&quot;</span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">uids</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">GroupMembers</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;room&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">Push</span><span class="p">(</span><span class="s">&quot;onMembers&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">AllMembers</span><span class="p">{</span><span class="nx">Members</span><span class="p">:</span><span class="w"> </span><span class="nx">uids</span><span class="p">})</span>
<span class="w">    </span><span class="nx">r</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">GroupBroadcast</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;chat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;room&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;onNewUser&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">NewUser</span><span class="p">{</span><span class="nx">Content</span><span class="p">:</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;New user: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">UID</span><span class="p">())})</span>
<span class="w">    </span><span class="nx">r</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">GroupAddMember</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;room&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">UID</span><span class="p">())</span><span class="w"> </span><span class="c1">// add session to group</span>

<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">OnClose</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">r</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">GroupRemoveMember</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;room&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">UID</span><span class="p">())</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">JoinResponse</span><span class="p">{</span><span class="nx">Result</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;success&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">Room</span><span class="p">)</span><span class="w"> </span><span class="nx">Message</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">*</span><span class="nx">UserMessage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">GroupBroadcast</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;chat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;room&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;onMessage&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;error broadcasting message&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="nx">pitaya</span><span class="p">.</span><span class="nx">Pitaya</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">conf</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">NewDefaultPitayaConfig</span><span class="p">()</span>
<span class="w">    </span><span class="nx">conf</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">LocalProcess</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">15</span>
<span class="w">    </span><span class="nx">conf</span><span class="p">.</span><span class="nx">Heartbeat</span><span class="p">.</span><span class="nx">Interval</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="mi">15</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="w">    </span><span class="nx">conf</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">Agent</span><span class="p">.</span><span class="nx">Messages</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="nx">conf</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">Messages</span><span class="p">.</span><span class="nx">Compression</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="c1">// Standalone 独立模式</span>
<span class="w">    </span><span class="nx">builder</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">pitaya</span><span class="p">.</span><span class="nx">NewDefaultBuilder</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;chat&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">pitaya</span><span class="p">.</span><span class="nx">Standalone</span><span class="p">,</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{},</span><span class="w"> </span><span class="o">*</span><span class="nx">conf</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// Cluster 集群模式 需要 etcd, nats, 看情况还有可能需要开启redis</span>
<span class="w">    </span><span class="c1">//builder := pitaya.NewDefaultBuilder(true, &quot;chat&quot;, pitaya.Cluster, map[string]string{}, *conf)</span>
<span class="w">    </span><span class="nx">builder</span><span class="p">.</span><span class="nx">AddAcceptor</span><span class="p">(</span><span class="nx">acceptor</span><span class="p">.</span><span class="nx">NewTCPAcceptor</span><span class="p">(</span><span class="s">&quot;:3251&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="nx">builder</span><span class="p">.</span><span class="nx">Groups</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">groups</span><span class="p">.</span><span class="nx">NewMemoryGroupService</span><span class="p">(</span><span class="nx">builder</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Groups</span><span class="p">.</span><span class="nx">Memory</span><span class="p">)</span>
<span class="w">    </span><span class="nx">app</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">builder</span><span class="p">.</span><span class="nx">Build</span><span class="p">()</span>

<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">Shutdown</span><span class="p">()</span>

<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">GroupCreate</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;room&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// rewrite component and handler name</span>
<span class="w">    </span><span class="nx">room</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewRoom</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
<span class="w">    </span><span class="nx">app</span><span class="p">.</span><span class="nx">Register</span><span class="p">(</span><span class="nx">room</span><span class="p">,</span>
<span class="w">        </span><span class="nx">component</span><span class="p">.</span><span class="nx">WithName</span><span class="p">(</span><span class="s">&quot;room&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">component</span><span class="p">.</span><span class="nx">WithNameFunc</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">ToLower</span><span class="p">),</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="nx">app</span><span class="p">.</span><span class="nx">Start</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_6">客户端部分<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<ul>
<li>在 https://blog.csdn.net/weixin_44627989/article/details/130355014 上的代码基础上进行的修改完成</li>
</ul>
<p>客户端的设计
<div class="highlight"><pre><span></span><code>    Control         Control   main.gd
        client      Node      client.gd

        txtContent  TextEdit
        txtInput    TextEdit
        txtNickName LineEdit

        btnConnected Button
        btnSend      Button

        txtHost      LineEdit
        txtPort      LineEdit
</code></pre></div></p>
<h6 id="3">客户端代码设计3个脚本<a class="headerlink" href="#3" title="Permanent link">&para;</a></h6>
<h6 id="maingd">main.gd<a class="headerlink" href="#maingd" title="Permanent link">&para;</a></h6>
<div class="highlight"><pre><span></span><code><span class="k">extends</span><span class="w"> </span><span class="n">Control</span>

<span class="err">@</span><span class="k">onready</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="n">client</span><span class="p">:</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">client</span>

<span class="err">@</span><span class="k">onready</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="n">txt_port</span><span class="p">:</span><span class="w"> </span><span class="n">LineEdit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">txtPort</span>
<span class="err">@</span><span class="k">onready</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="n">txt_host</span><span class="p">:</span><span class="w"> </span><span class="n">LineEdit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">txtHost</span>
<span class="err">@</span><span class="k">onready</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="n">txt_input</span><span class="p">:</span><span class="w"> </span><span class="n">TextEdit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">txtInput</span>
<span class="err">@</span><span class="k">onready</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="n">txt_nick_name</span><span class="p">:</span><span class="w"> </span><span class="n">LineEdit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">txtNickName</span>

<span class="err">@</span><span class="k">onready</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="n">txt_content</span><span class="p">:</span><span class="w"> </span><span class="n">TextEdit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">txtContent</span>
<span class="err">@</span><span class="k">onready</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="n">txt_rtlabel</span><span class="p">:</span><span class="w"> </span><span class="n">RichTextLabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">txtRTLabel</span>

<span class="err">@</span><span class="k">onready</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="n">btn_connected</span><span class="p">:</span><span class="w"> </span><span class="n">Button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">btnConnected</span>
<span class="err">@</span><span class="k">onready</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="n">btn_send</span><span class="p">:</span><span class="w"> </span><span class="n">Button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">btnSend</span>


<span class="k">func</span><span class="w"> </span><span class="n">_ready</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="n">btn_send</span><span class="o">.</span><span class="n">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">    </span><span class="k">pass</span>

<span class="k">func</span><span class="w"> </span><span class="n">_on_btn_connected_pressed</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">txt_host</span><span class="o">.</span><span class="n">text</span><span class="p">;</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">(</span><span class="n">txt_port</span><span class="o">.</span><span class="n">text</span><span class="p">);</span>

<span class="w">    </span><span class="n">client</span><span class="o">.</span><span class="n">connect_server</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">_rev_connected</span><span class="p">,</span><span class="w"> </span><span class="n">_rev_msg</span><span class="p">);</span>
<span class="w">    </span><span class="n">btn_connected</span><span class="o">.</span><span class="n">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">tween</span><span class="p">:</span><span class="n">Tween</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_tween</span><span class="p">();</span>
<span class="w">    </span><span class="n">tween</span><span class="o">.</span><span class="n">tween_interval</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">tween</span><span class="o">.</span><span class="n">tween_callback</span><span class="p">(</span><span class="k">func</span><span class="p">():</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="o">.</span><span class="n">is_connected_server</span><span class="p">()):</span>
<span class="w">            </span><span class="n">btn_connected</span><span class="o">.</span><span class="n">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">)</span>

<span class="w">    </span><span class="k">pass</span><span class="w"> </span><span class="c1"># Replace with function body.</span>

<span class="k">func</span><span class="w"> </span><span class="n">_push_msg</span><span class="p">(</span><span class="n">uname</span><span class="p">:</span><span class="nb nb-Type">String</span><span class="p">,</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="nb nb-Type">String</span><span class="p">)</span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">tmp_str</span><span class="p">:</span><span class="nb nb-Type">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uname</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">txt_content</span><span class="o">.</span><span class="n">insert_text_at_caret</span><span class="p">(</span><span class="n">tmp_str</span><span class="p">)</span>
<span class="w">    </span><span class="c1">#txt_rtlabel.add_text(str);</span>
<span class="w">    </span><span class="k">pass</span>

<span class="c1">#----------------------------------------------`</span>
<span class="k">func</span><span class="w"> </span><span class="n">onNewUser</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="o">.</span><span class="n">jsonData</span><span class="p">();</span>
<span class="w">    </span><span class="n">_push_msg</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">content</span><span class="p">);</span>
<span class="w">    </span><span class="k">pass</span>

<span class="k">func</span><span class="w"> </span><span class="n">onMembers</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="o">.</span><span class="n">jsonData</span><span class="p">();</span>
<span class="w">    </span><span class="n">_push_msg</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span><span class="w">  </span><span class="s2">&quot;members: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">members</span><span class="p">));</span>
<span class="w">    </span><span class="k">pass</span>

<span class="k">func</span><span class="w"> </span><span class="n">onJoin</span><span class="p">(</span><span class="n">succ</span><span class="p">:</span><span class="nb nb-Type">bool</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">:</span><span class="n">Variant</span><span class="p">,</span><span class="w"> </span><span class="n">rt</span><span class="p">:</span><span class="nb nb-Type">String</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">succ</span><span class="p">):</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;err not get message rep:&quot;</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">rt</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="o">.</span><span class="n">jsonData</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="n">_push_msg</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">result</span><span class="p">);</span>
<span class="w">        </span><span class="n">client</span><span class="o">.</span><span class="n">set_push_func</span><span class="p">(</span><span class="s1">&#39;onMessage&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">onMessage</span><span class="p">);</span>
<span class="w">        </span><span class="c1">#starx.on(&#39;onMessage&#39;, onMessage)</span>
<span class="w">    </span><span class="k">pass</span>

<span class="k">func</span><span class="w"> </span><span class="n">onMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="o">.</span><span class="n">jsonData</span><span class="p">();</span>
<span class="w">    </span><span class="n">_push_msg</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<span class="w">    </span><span class="k">pass</span>

<span class="k">func</span><span class="w"> </span><span class="n">_rev_connected</span><span class="p">(</span><span class="n">succ</span><span class="p">:</span><span class="nb nb-Type">bool</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">succ</span><span class="p">):</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;connect to server&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">client</span><span class="o">.</span><span class="n">set_push_func</span><span class="p">(</span><span class="s2">&quot;onNewUser&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">onNewUser</span><span class="p">);</span>
<span class="w">        </span><span class="n">client</span><span class="o">.</span><span class="n">set_push_func</span><span class="p">(</span><span class="s2">&quot;onMembers&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">onMembers</span><span class="p">);</span>

<span class="w">        </span><span class="n">client</span><span class="o">.</span><span class="n">SendRequest</span><span class="p">(</span><span class="s2">&quot;room.join&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">onJoin</span><span class="p">);</span>
<span class="w">        </span><span class="n">btn_send</span><span class="o">.</span><span class="n">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="p">:</span>
<span class="w">        </span><span class="n">btn_send</span><span class="o">.</span><span class="n">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">        </span><span class="n">btn_connected</span><span class="o">.</span><span class="n">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">pass</span>

<span class="k">func</span><span class="w"> </span><span class="n">_rev_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--msg---:&quot;</span><span class="p">,</span><span class="n">msg</span><span class="p">);</span>
<span class="w">    </span><span class="k">pass</span>

<span class="k">func</span><span class="w"> </span><span class="n">_on_btn_send_pressed</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="o">.</span><span class="n">is_connected_server</span><span class="p">()):</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot; not connected &quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">nn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">txt_nick_name</span><span class="o">.</span><span class="n">text</span><span class="p">;</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">ctt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">txt_input</span><span class="o">.</span><span class="n">text</span><span class="p">;</span>

<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">nn</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;content&quot;</span><span class="p">:</span><span class="n">ctt</span><span class="w"> </span><span class="p">})</span><span class="o">.</span><span class="n">to_utf8_buffer</span><span class="p">();</span>
<span class="w">    </span><span class="n">client</span><span class="o">.</span><span class="n">SendNotify</span><span class="p">(</span><span class="s1">&#39;room.message&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="k">pass</span><span class="w"> </span><span class="c1"># Replace with function body.</span>
</code></pre></div>
<h6 id="streamtcpgd">StreamTCP.gd<a class="headerlink" href="#streamtcpgd" title="Permanent link">&para;</a></h6>
<div class="highlight"><pre><span></span><code><span class="k">extends</span><span class="w"> </span><span class="n">Node</span>
<span class="k">class_name</span><span class="w"> </span><span class="n">StreamTCP</span>

<span class="c1">####</span>
<span class="c1">## 从 复制下来进行的修改</span>
<span class="c1">## https://www.bytesnsprites.com/posts/2021/creating-a-tcp-client-in-godot/</span>
<span class="c1">###</span>

<span class="k">signal</span><span class="w"> </span><span class="n">connected</span>
<span class="k">signal</span><span class="w"> </span><span class="n">data</span>
<span class="k">signal</span><span class="w"> </span><span class="n">disconnected</span>
<span class="k">signal</span><span class="w"> </span><span class="n">error</span>

<span class="k">var</span><span class="w"> </span><span class="n">_status</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="k">var</span><span class="w"> </span><span class="n">_stream</span><span class="p">:</span><span class="w"> </span><span class="n">StreamPeerTCP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StreamPeerTCP</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

<span class="k">func</span><span class="w"> </span><span class="n">_ready</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="n">_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stream</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>

<span class="k">func</span><span class="w"> </span><span class="n">_process</span><span class="p">(</span><span class="n">_delta</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">float</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">new_status</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stream</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">new_status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">_status</span><span class="p">:</span>
<span class="w">        </span><span class="n">_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_status</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">_status</span><span class="p">:</span>
<span class="w">            </span><span class="n">_stream</span><span class="o">.</span><span class="n">STATUS_NONE</span><span class="p">:</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Disconnected from host.&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="n">emit_signal</span><span class="p">(</span><span class="s2">&quot;disconnected&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="n">_stream</span><span class="o">.</span><span class="n">STATUS_CONNECTING</span><span class="p">:</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connecting to host.&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="n">_stream</span><span class="o">.</span><span class="n">STATUS_CONNECTED</span><span class="p">:</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connected to host.&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="n">emit_signal</span><span class="p">(</span><span class="s2">&quot;connected&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="n">_stream</span><span class="o">.</span><span class="n">STATUS_ERROR</span><span class="p">:</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error with socket stream.&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="n">emit_signal</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">_status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">_stream</span><span class="o">.</span><span class="n">STATUS_CONNECTED</span><span class="p">:</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">available_bytes</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stream</span><span class="o">.</span><span class="n">get_available_bytes</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">available_bytes</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<span class="w">            </span><span class="c1">#print(&quot;available bytes: &quot;, available_bytes)</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">buf_array</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">Array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stream</span><span class="o">.</span><span class="n">get_partial_data</span><span class="p">(</span><span class="n">available_bytes</span><span class="p">)</span>
<span class="w">            </span><span class="c1"># Check for read error.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">buf_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">OK</span><span class="p">:</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error getting data from stream: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">buf_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="w">                </span><span class="n">emit_signal</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">else</span><span class="p">:</span>
<span class="w">                </span><span class="n">emit_signal</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">buf_array</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="k">func</span><span class="w"> </span><span class="n">is_connected_server</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="p">:</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">state</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stream</span><span class="o">.</span><span class="n">get_status</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">_stream</span><span class="o">.</span><span class="n">STATUS_CONNECTED</span><span class="p">;</span>

<span class="k">func</span><span class="w"> </span><span class="n">connect_to_host</span><span class="p">(</span><span class="n">host</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">String</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connecting to </span><span class="si">%s</span><span class="s2">:</span><span class="si">%d</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">[</span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">])</span>
<span class="w">    </span><span class="c1"># Reset status so we can tell if it changes to error again.</span>
<span class="w">    </span><span class="n">_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stream</span><span class="o">.</span><span class="n">STATUS_NONE</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">_stream</span><span class="o">.</span><span class="n">connect_to_host</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">OK</span><span class="p">:</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error connecting to host.&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="n">emit_signal</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">else</span><span class="p">:</span>
<span class="w">        </span><span class="c1">#_stream.set_no_delay(true)</span>
<span class="w">        </span><span class="n">_stream</span><span class="o">.</span><span class="n">poll</span><span class="p">();</span>

<span class="k">func</span><span class="w"> </span><span class="n">disconnect_from_host</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_connected_server</span><span class="p">()):</span>
<span class="w">        </span><span class="n">_stream</span><span class="o">.</span><span class="n">disconnect_from_host</span><span class="p">();</span>

<span class="k">func</span><span class="w"> </span><span class="n">send</span><span class="p">(</span><span class="n">buff</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">PackedByteArray</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">_status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">_stream</span><span class="o">.</span><span class="n">STATUS_CONNECTED</span><span class="p">:</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Stream is not currently connected.&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">false</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">err</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stream</span><span class="o">.</span><span class="n">put_data</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">OK</span><span class="p">:</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error writing to stream: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">false</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="bp">true</span>
</code></pre></div>
<h6 id="clientgd">client.gd<a class="headerlink" href="#clientgd" title="Permanent link">&para;</a></h6>
<div class="highlight"><pre><span></span><code><span class="k">extends</span><span class="w"> </span><span class="n">Node</span>
<span class="k">class_name</span><span class="w">  </span><span class="n">Client</span>



<span class="w"> </span><span class="c1">#/**</span>
<span class="w">   </span><span class="c1">#* Package protocol encode.</span>
<span class="w">   </span><span class="c1">#*</span>
<span class="w">   </span><span class="c1">#* Pomelo package format:</span>
<span class="w">   </span><span class="c1">#* +------+-------------+------------------+</span>
<span class="w">   </span><span class="c1">#* | type | body length |       body       |</span>
<span class="w">   </span><span class="c1">#* +------+-------------+------------------+</span>
<span class="w">   </span><span class="c1">#*</span>
<span class="w">   </span><span class="c1">#* Head: 4bytes</span>
<span class="w">   </span><span class="c1">#*   0: package type,</span>
<span class="w">   </span><span class="c1">#*      1 - handshake,</span>
<span class="w">   </span><span class="c1">#*      2 - handshake ack,</span>
<span class="w">   </span><span class="c1">#*      3 - heartbeat,</span>
<span class="w">   </span><span class="c1">#*      4 - data</span>
<span class="w">   </span><span class="c1">#*      5 - kick</span>
<span class="w">   </span><span class="c1">#*   1 - 3: big-endian body length</span>
<span class="w">   </span><span class="c1">#* Body: body length bytes</span>
<span class="w">   </span><span class="c1">#*</span>
<span class="w">   </span><span class="c1">#* @param  {Number}    type   package type</span>
<span class="w">   </span><span class="c1">#* @param  {ByteArray} body   body content in bytes</span>
<span class="w">   </span><span class="c1">#* @return {ByteArray}        new byte array that contains encode result</span>
<span class="w">   </span><span class="c1">#*/</span>

<span class="c1"># 5种 基本类型消息</span>

<span class="k">const</span><span class="w"> </span><span class="n">PACK_TYPE_HANDSHAKE</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x01</span>
<span class="k">const</span><span class="w"> </span><span class="n">PACK_TYPE_HANDSHAKEACK</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x02</span>
<span class="k">const</span><span class="w"> </span><span class="n">PACK_TYPE_HEARTBEAT</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x03</span>
<span class="k">const</span><span class="w"> </span><span class="n">PACK_TYPE_DATA</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x04</span>
<span class="k">const</span><span class="w"> </span><span class="n">PACK_TYPE_KICK</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x05</span>

<span class="k">const</span><span class="w"> </span><span class="n">MSG_TYPE_REQUEST</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00</span>
<span class="k">const</span><span class="w"> </span><span class="n">MSG_TYPE_NOTIFY</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x01</span>
<span class="k">const</span><span class="w"> </span><span class="n">MSG_TYPE_RESPONSE</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x02</span>
<span class="k">const</span><span class="w"> </span><span class="n">MSG_TYPE_PUSH</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x03</span>

<span class="k">const</span><span class="w"> </span><span class="n">MSG_MASK_ERROR</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x20</span>
<span class="k">const</span><span class="w"> </span><span class="n">MSG_MASK_GZIP</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x10</span>
<span class="k">const</span><span class="w"> </span><span class="n">MSG_MASK_MSGROUTECOMPRESS</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x01</span>
<span class="k">const</span><span class="w"> </span><span class="n">MSG_MASK_MSGTYPE</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x07</span>
<span class="k">const</span><span class="w"> </span><span class="n">MSG_MASK_SGROUTELENGTH</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFF</span>
<span class="k">const</span><span class="w"> </span><span class="n">MSG_MASK_MSGHEADLENGTH</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x02</span>

<span class="k">const</span><span class="w"> </span><span class="n">HeadLength</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>
<span class="k">const</span><span class="w"> </span><span class="n">MaxPacketSize</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="c1">#16MB</span>

<span class="k">var</span><span class="w"> </span><span class="n">_wait_cb_array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="k">var</span><span class="w"> </span><span class="n">lastMsgId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="k">var</span><span class="w"> </span><span class="n">clientHandshakeData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span>
<span class="k">var</span><span class="w"> </span><span class="n">packet_encoder</span><span class="p">:</span><span class="n">PomeloPacketEncoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span>
<span class="k">var</span><span class="w"> </span><span class="n">packet_decoder</span><span class="p">:</span><span class="n">PomeloPacketDecoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span>
<span class="k">var</span><span class="w"> </span><span class="n">message_encoder</span><span class="p">:</span><span class="n">MessagesEncoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span>
<span class="k">var</span><span class="w"> </span><span class="n">compression</span><span class="p">:</span><span class="n">Compression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span>
<span class="k">var</span><span class="w"> </span><span class="n">heartbeatTimeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="k">var</span><span class="w"> </span><span class="n">requestTimeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
<span class="k">var</span><span class="w"> </span><span class="n">serializerType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;json&quot;</span><span class="p">;</span>

<span class="k">var</span><span class="w"> </span><span class="n">push_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="k">var</span><span class="w"> </span><span class="n">_is_handshake</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="k">var</span><span class="w"> </span><span class="n">_is_client_connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span>

<span class="k">const</span><span class="w"> </span><span class="n">RECONNECT_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.0</span>

<span class="k">var</span><span class="w"> </span><span class="n">_host</span><span class="p">:</span><span class="nb nb-Type">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;127.0.0.1&quot;</span>
<span class="k">var</span><span class="w"> </span><span class="n">_port</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">40000</span><span class="p">;</span>
<span class="c1">#--------------------------------------------------------------</span>
<span class="c1">#--------------------------------------------------------</span>
<span class="c1"># 附加回调</span>
<span class="k">var</span><span class="w"> </span><span class="n">_cb_connected_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>
<span class="k">var</span><span class="w"> </span><span class="n">_cb_msg_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>
<span class="k">var</span><span class="w"> </span><span class="n">heartbeatTimer</span><span class="p">:</span><span class="n">Timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>

<span class="k">func</span><span class="w"> </span><span class="n">is_handshaked</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="p">:</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_is_handshake</span><span class="p">;</span>

<span class="k">func</span><span class="w"> </span><span class="n">is_connected_server</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="p">:</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_is_client_connected</span><span class="p">;</span>

<span class="k">func</span><span class="w"> </span><span class="n">set_push_func</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="nb nb-Type">String</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">:</span><span class="n">Callable</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="n">push_func</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cb</span><span class="p">;</span>

<span class="k">func</span><span class="w"> </span><span class="n">del_push_func</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">push_func</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">key</span><span class="p">)):</span>
<span class="w">        </span><span class="n">push_func</span><span class="o">.</span><span class="n">erase</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>

<span class="k">func</span><span class="w"> </span><span class="n">connect_server</span><span class="p">(</span><span class="n">host</span><span class="p">:</span><span class="nb nb-Type">String</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="p">,</span><span class="w"> </span><span class="n">cbconnected</span><span class="p">:</span><span class="n">Callable</span><span class="p">,</span><span class="w"> </span><span class="n">cbmsg</span><span class="p">:</span><span class="n">Callable</span><span class="p">):</span>
<span class="w">    </span><span class="n">_cb_connected_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbconnected</span><span class="p">;</span>
<span class="w">    </span><span class="n">_cb_msg_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbmsg</span><span class="p">;</span>
<span class="w">    </span><span class="n">_host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host</span><span class="p">;</span>
<span class="w">    </span><span class="n">_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>
<span class="w">    </span><span class="n">_stream</span><span class="o">.</span><span class="n">connect_to_host</span><span class="p">(</span><span class="n">_host</span><span class="p">,</span><span class="w"> </span><span class="n">_port</span><span class="p">);</span>

<span class="c1">#--------------------------------------------------------------</span>
<span class="c1">#--------------------------------------------------------------</span>
<span class="k">var</span><span class="w"> </span><span class="n">_stream</span><span class="p">:</span><span class="w"> </span><span class="n">StreamTCP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StreamTCP</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

<span class="k">func</span><span class="w"> </span><span class="n">_ready</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;connect ready&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">compression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Compression</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="n">packet_encoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PomeloPacketEncoder</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="n">packet_decoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PomeloPacketDecoder</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="n">message_encoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessagesEncoder</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="n">message_encoder</span><span class="o">.</span><span class="n">compression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compression</span>

<span class="w">    </span><span class="n">heartbeatTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Timer</span><span class="o">.</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">heartbeatTimer</span><span class="o">.</span><span class="n">one_shot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">heartbeatTimer</span><span class="o">.</span><span class="n">autostart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">heartbeatTimer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">_handle_Heartbeats_send</span><span class="p">);</span>
<span class="w">    </span><span class="n">add_child</span><span class="p">(</span><span class="n">heartbeatTimer</span><span class="p">);</span>

<span class="w">    </span><span class="n">_stream</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;connected&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">_handle_client_connected</span><span class="p">)</span>
<span class="w">    </span><span class="n">_stream</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;disconnected&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">_handle_client_disconnected</span><span class="p">)</span>
<span class="w">    </span><span class="n">_stream</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">_handle_client_error</span><span class="p">)</span>
<span class="w">    </span><span class="n">_stream</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">_handle_client_data</span><span class="p">)</span>
<span class="w">    </span><span class="n">add_child</span><span class="p">(</span><span class="n">_stream</span><span class="p">)</span>

<span class="k">func</span><span class="w"> </span><span class="n">_connect_after_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">float</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">get_tree</span><span class="p">()</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span><span class="o">.</span><span class="n">timeout</span><span class="w"> </span><span class="c1"># Delay for timeout</span>
<span class="w">    </span><span class="n">_stream</span><span class="o">.</span><span class="n">connect_to_host</span><span class="p">(</span><span class="n">_host</span><span class="p">,</span><span class="w"> </span><span class="n">_port</span><span class="p">)</span>

<span class="k">func</span><span class="w"> </span><span class="n">_handle_client_connected</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Client connected to server.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">_send_handshake</span><span class="p">();</span>

<span class="k">func</span><span class="w"> </span><span class="n">_handle_client_data</span><span class="p">(</span><span class="n">buf</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">PackedByteArray</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="c1">#print(&quot;rev data len:&quot;,len(buf));</span>
<span class="w">    </span><span class="n">_try_read_packs</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

<span class="k">func</span><span class="w"> </span><span class="n">_handle_client_disconnected</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Client disconnected from server.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">_done_client_disconcted</span><span class="p">();</span>
<span class="w">    </span><span class="c1">#_connect_after_timeout(RECONNECT_TIMEOUT) # Try to reconnect after 3 seconds</span>

<span class="k">func</span><span class="w"> </span><span class="n">_handle_client_error</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Client error.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">_done_client_disconcted</span><span class="p">();</span>
<span class="w">    </span><span class="c1">#_connect_after_timeout(RECONNECT_TIMEOUT) # Try to reconnect after 3 seconds</span>

<span class="k">func</span><span class="w"> </span><span class="n">_send_handshake</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">hand_shake_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;sys&quot;</span><span class="p">:{</span><span class="s2">&quot;clientVersion&quot;</span><span class="p">:</span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;clientBuildNumber&quot;</span><span class="p">:</span><span class="s2">&quot;999&quot;</span><span class="p">,</span><span class="s2">&quot;platform&quot;</span><span class="p">:</span><span class="s2">&quot;pc&quot;</span><span class="p">}};</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">datstr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">hand_shake_data</span><span class="p">)</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packet_encoder</span><span class="o">.</span><span class="n">Encode</span><span class="p">(</span><span class="n">PACK_TYPE_HANDSHAKE</span><span class="p">,</span><span class="w"> </span><span class="n">datstr</span><span class="o">.</span><span class="n">to_utf8_buffer</span><span class="p">())</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">:</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;net connect fail&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span>

<span class="w">    </span><span class="n">_stream</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="k">func</span><span class="w"> </span><span class="n">_try_read_packs</span><span class="p">(</span><span class="n">buf</span><span class="p">:</span><span class="nb nb-Type">PackedByteArray</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packet_decoder</span><span class="o">.</span><span class="n">Decode</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">:</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;net read fail len:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)))</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">is_handshaked</span><span class="p">()):</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">handshakePacket</span><span class="p">:</span><span class="n">Packet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">handshakePacket</span><span class="o">.</span><span class="n">Type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PACK_TYPE_HANDSHAKE</span><span class="p">):</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------ get something:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">handshakePacket</span><span class="o">.</span><span class="n">Type</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>

<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get handshake type:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">handshakePacket</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">compression</span><span class="o">.</span><span class="n">IsCompressed</span><span class="p">(</span><span class="n">handshakePacket</span><span class="o">.</span><span class="n">Data</span><span class="p">):</span>
<span class="w">            </span><span class="n">handshakePacket</span><span class="o">.</span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compression</span><span class="o">.</span><span class="n">InflateData</span><span class="p">(</span><span class="n">handshakePacket</span><span class="o">.</span><span class="n">Data</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">handshakePacket</span><span class="o">.</span><span class="n">Data</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">:</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;comp err&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">handshake</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handshakePacket</span><span class="o">.</span><span class="n">jsonData</span><span class="p">();</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;got handshake from sv, data: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">handshake</span><span class="p">)</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">routeDict</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">handshake</span><span class="p">[</span><span class="s2">&quot;sys&quot;</span><span class="p">]):</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">sys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handshake</span><span class="p">[</span><span class="s2">&quot;sys&quot;</span><span class="p">];</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sys</span><span class="p">[</span><span class="s2">&quot;dict&quot;</span><span class="p">]):</span>
<span class="w">                </span><span class="n">routeDict</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sys</span><span class="p">[</span><span class="s2">&quot;dict&quot;</span><span class="p">];</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sys</span><span class="p">[</span><span class="s2">&quot;heartbeat&quot;</span><span class="p">]):</span>
<span class="w">                </span><span class="n">heartbeatTimeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sys</span><span class="p">[</span><span class="s2">&quot;heartbeat&quot;</span><span class="p">];</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sys</span><span class="p">[</span><span class="s2">&quot;serializer&quot;</span><span class="p">]):</span>
<span class="w">                </span><span class="n">serializerType</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">sys</span><span class="p">[</span><span class="s2">&quot;serializer&quot;</span><span class="p">];</span>

<span class="w">        </span><span class="n">message_encoder</span><span class="o">.</span><span class="n">SetDictionary</span><span class="p">(</span><span class="n">routeDict</span><span class="p">)</span>

<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packet_encoder</span><span class="o">.</span><span class="n">Encode</span><span class="p">(</span><span class="n">PACK_TYPE_HANDSHAKEACK</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">PackedByteArray</span><span class="p">())</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span>

<span class="w">        </span><span class="n">_stream</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="w">        </span><span class="n">_is_handshake</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">        </span><span class="n">_is_client_connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span>

<span class="w">        </span><span class="n">heartbeatTimer</span><span class="o">.</span><span class="n">wait_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heartbeatTimeout</span><span class="p">;</span>
<span class="w">        </span><span class="n">heartbeatTimer</span><span class="o">.</span><span class="n">start</span><span class="p">();</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_cb_connected_func</span><span class="p">):</span>
<span class="w">            </span><span class="n">_cb_connected_func</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">true</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot; rev pack num:&quot;</span><span class="p">,</span><span class="n">packets</span><span class="o">.</span><span class="n">size</span><span class="p">());</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">packets</span><span class="p">:</span>
<span class="w">        </span><span class="n">_handle_packets</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="w">    </span><span class="k">pass</span>
<span class="c1">#--------------------------------------------------------------</span>

<span class="k">func</span><span class="w"> </span><span class="n">_newMsgID</span><span class="p">():</span>
<span class="w">    </span><span class="n">lastMsgId</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">lastMsgId</span>

<span class="c1">#SendRequest sends a request to the server</span>
<span class="k">func</span><span class="w"> </span><span class="n">SendRequest</span><span class="p">(</span><span class="n">route</span><span class="p">:</span><span class="nb nb-Type">String</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">:</span><span class="nb nb-Type">String</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">):</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="n">m</span><span class="o">.</span><span class="n">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MSG_TYPE_REQUEST</span>
<span class="w">    </span><span class="n">m</span><span class="o">.</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_newMsgID</span><span class="p">()</span>
<span class="w">    </span><span class="n">m</span><span class="o">.</span><span class="n">Route</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">route</span>
<span class="w">    </span><span class="n">m</span><span class="o">.</span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">to_utf8_buffer</span><span class="p">();</span>
<span class="w">    </span><span class="n">m</span><span class="o">.</span><span class="n">SendAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">(</span><span class="n">Time</span><span class="o">.</span><span class="n">get_unix_time_from_system</span><span class="p">())</span>
<span class="w">    </span><span class="n">m</span><span class="o">.</span><span class="n">Callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cb</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_buildPacket</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="w">    </span><span class="n">_wait_cb_array</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span>

<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- SendRequest route:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">route</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot; msgid:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">ID</span><span class="p">);</span>
<span class="w">    </span><span class="n">_stream</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="c1">#SendNotify sends a notify to the server</span>
<span class="k">func</span><span class="w"> </span><span class="n">SendNotify</span><span class="p">(</span><span class="n">route</span><span class="p">:</span><span class="nb nb-Type">String</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">:</span><span class="nb nb-Type">PackedByteArray</span><span class="p">):</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="n">m</span><span class="o">.</span><span class="n">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MSG_TYPE_NOTIFY</span>
<span class="w">    </span><span class="n">m</span><span class="o">.</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_newMsgID</span><span class="p">()</span>
<span class="w">    </span><span class="n">m</span><span class="o">.</span><span class="n">Route</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">route</span>
<span class="w">    </span><span class="n">m</span><span class="o">.</span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span>
<span class="w">    </span><span class="n">m</span><span class="o">.</span><span class="n">SendAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">(</span><span class="n">Time</span><span class="o">.</span><span class="n">get_unix_time_from_system</span><span class="p">())</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_buildPacket</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- SendNotify route:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">route</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot; msgid:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">ID</span><span class="p">);</span>
<span class="w">    </span><span class="n">_stream</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="k">func</span><span class="w"> </span><span class="n">_buildPacket</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="n">Message</span><span class="p">):</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">encMsg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message_encoder</span><span class="o">.</span><span class="n">Encode</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packet_encoder</span><span class="o">.</span><span class="n">Encode</span><span class="p">(</span><span class="n">PACK_TYPE_DATA</span><span class="p">,</span><span class="w"> </span><span class="n">encMsg</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">p</span>

<span class="k">func</span><span class="w"> </span><span class="n">_handle_Heartbeats_send</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packet_encoder</span><span class="o">.</span><span class="n">Encode</span><span class="p">(</span><span class="n">PACK_TYPE_HEARTBEAT</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">PackedByteArray</span><span class="p">())</span>
<span class="w">    </span><span class="n">_stream</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="k">func</span><span class="w"> </span><span class="n">_handle_packets</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">Type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PACK_TYPE_DATA</span><span class="p">:</span>
<span class="w">        </span><span class="c1">#handle data</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message_encoder</span><span class="o">.</span><span class="n">Decode</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">Data</span><span class="p">)</span>
<span class="w">        </span><span class="n">_handle_rev_one_packet</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">Type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PACK_TYPE_KICK</span><span class="p">:</span>
<span class="w">        </span><span class="n">_done_client_disconcted</span><span class="p">();</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;kick from server&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">Type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PACK_TYPE_HEARTBEAT</span><span class="p">:</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------ heartbeat----&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">pass</span>
<span class="w">    </span><span class="k">else</span><span class="p">:</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- un oper pack:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">Type</span><span class="p">);</span>

<span class="k">func</span><span class="w"> </span><span class="n">_requestReaper</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">is_connected_server</span><span class="p">()):</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">msgid</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">_wait_cb_array</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">msg</span><span class="p">:</span><span class="n">Message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_wait_cb_array</span><span class="p">[</span><span class="n">msgid</span><span class="p">];</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb nb-Type">int</span><span class="p">(</span><span class="n">Time</span><span class="o">.</span><span class="n">get_unix_time_from_system</span><span class="p">())</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">msg</span><span class="o">.</span><span class="n">SendAt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">requestTimeout</span><span class="p">):</span>
<span class="w">            </span><span class="n">_wait_cb_array</span><span class="o">.</span><span class="n">erase</span><span class="p">(</span><span class="n">msgid</span><span class="p">);</span>
<span class="w">            </span><span class="n">_handle_timeout_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

<span class="k">func</span><span class="w"> </span><span class="n">_handle_rev_one_packet</span><span class="p">(</span><span class="n">m</span><span class="p">:</span><span class="n">Message</span><span class="p">):</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MSG_TYPE_RESPONSE</span><span class="p">:</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- respones msgid:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot; Route:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Route</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">ID</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">_wait_cb_array</span><span class="p">:</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">cb_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_wait_cb_array</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">ID</span><span class="p">]</span>
<span class="w">            </span><span class="n">_wait_cb_array</span><span class="o">.</span><span class="n">erase</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
<span class="w">            </span><span class="n">cb_msg</span><span class="o">.</span><span class="n">Callback</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">true</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">else</span><span class="p">:</span>
<span class="w">        </span><span class="n">_handle_push_msg</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="k">func</span><span class="w"> </span><span class="n">_handle_push_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="n">Message</span><span class="p">):</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot; _handle_push_msg ...msg.Route :&quot;</span><span class="p">,</span><span class="n">msg</span><span class="o">.</span><span class="n">Route</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot; type:&quot;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">cb_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">push_func</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">Route</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">cb_func</span><span class="p">:</span>
<span class="w">        </span><span class="n">cb_func</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="p">(</span><span class="n">_cb_msg_func</span><span class="p">):</span>
<span class="w">        </span><span class="n">_cb_msg_func</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

<span class="k">func</span><span class="w"> </span><span class="n">_handle_timeout_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="n">Message</span><span class="p">):</span>
<span class="w">    </span><span class="n">msg</span><span class="o">.</span><span class="n">Callback</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">false</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot; message request is time out&quot;</span><span class="p">)</span>

<span class="k">func</span><span class="w"> </span><span class="n">_process</span><span class="p">(</span><span class="n">_delta</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">float</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="n">_requestReaper</span><span class="p">();</span>

<span class="k">func</span><span class="w"> </span><span class="n">_done_client_disconcted</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="p">:</span>
<span class="w">    </span><span class="n">_is_handshake</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">_is_client_connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span>
<span class="w">    </span><span class="n">_stream</span><span class="o">.</span><span class="n">disconnect_from_host</span><span class="p">();</span>
<span class="w">    </span><span class="n">heartbeatTimer</span><span class="o">.</span><span class="n">stop</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_cb_connected_func</span><span class="p">):</span>
<span class="w">        </span><span class="n">_cb_connected_func</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">false</span><span class="p">);</span>

<span class="k">func</span><span class="w"> </span><span class="n">_exit_tree</span><span class="p">():</span>
<span class="w">    </span><span class="n">_done_client_disconcted</span><span class="p">();</span>

<span class="c1">#--------------------------------------------------------------</span>
<span class="c1"># 可以在下面的位置好到对应的编码解码以及消息的对应处理</span>
<span class="c1"># github.com/topfreegames/pitaya/v2@v2.11.21/conn</span>
<span class="c1">#--------------------------------------------------------------</span>
<span class="k">class</span><span class="w"> </span><span class="n">Message</span><span class="p">:</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">Type</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">ID</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">Route</span><span class="p">:</span><span class="nb nb-Type">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">Data</span><span class="p">:</span><span class="nb nb-Type">PackedByteArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">PackedByteArray</span><span class="p">()</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">compressed</span><span class="p">:</span><span class="nb nb-Type">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">Err</span><span class="p">:</span><span class="nb nb-Type">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">SendAt</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">Callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span>

<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">jsonData</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Variant</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">JSON</span><span class="o">.</span><span class="n">parse_string</span><span class="p">(</span><span class="n">Data</span><span class="o">.</span><span class="n">get_string_from_utf8</span><span class="p">());</span>

<span class="k">class</span><span class="w"> </span><span class="n">Packet</span><span class="p">:</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">Type</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">Length</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">Data</span><span class="p">:</span><span class="nb nb-Type">PackedByteArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">PackedByteArray</span><span class="p">()</span>

<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">jsonData</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Variant</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">JSON</span><span class="o">.</span><span class="n">parse_string</span><span class="p">(</span><span class="n">Data</span><span class="o">.</span><span class="n">get_string_from_utf8</span><span class="p">());</span>

<span class="k">class</span><span class="w"> </span><span class="n">PomeloPacketEncoder</span><span class="p">:</span>
<span class="c1">#Encode create a packet.Packet from  the raw bytes slice and then encode to network bytes slice</span>
<span class="c1">#Protocol refs: https://github.com/NetEase/pomelo/wiki/Communication-Protocol</span>
<span class="c1">#</span>
<span class="c1"># -&lt;type&gt;-|--------&lt;length&gt;--------|-&lt;data&gt;-</span>
<span class="c1"># --------|------------------------|--------</span>
<span class="c1"># 1 byte packet type, 3 bytes packet data length(big end), and data segment</span>
<span class="w">    </span><span class="c1">## return null or PackedByteArray</span>
<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">Encode</span><span class="p">(</span><span class="n">typ</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">:</span><span class="nb nb-Type">PackedByteArray</span><span class="p">):</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">typ</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">PACK_TYPE_HANDSHAKE</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">typ</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">PACK_TYPE_KICK</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MaxPacketSize</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">PackedByteArray</span><span class="p">()</span>
<span class="w">        </span><span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
<span class="w">        </span><span class="n">buf</span><span class="o">.</span><span class="n">append_array</span><span class="p">(</span><span class="n">IntToBytes</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
<span class="w">        </span><span class="n">buf</span><span class="o">.</span><span class="n">append_array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">buf</span>

<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">IntToBytes</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">PackedByteArray</span><span class="p">()</span>
<span class="w">        </span><span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span>
<span class="w">        </span><span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span>
<span class="w">        </span><span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">buf</span>

<span class="k">class</span><span class="w"> </span><span class="n">PomeloPacketDecoder</span><span class="p">:</span>

<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">BytesToInt</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">bytev</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">b</span><span class="p">:</span>
<span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">(</span><span class="n">result</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">(</span><span class="n">bytev</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span>

<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">ParseHeader</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HeadLength</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">typ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">typ</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">PACK_TYPE_HANDSHAKE</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">typ</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">PACK_TYPE_KICK</span><span class="p">:</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;err header nu&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">typ</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BytesToInt</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MaxPacketSize</span><span class="p">:</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;err size&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">typ</span><span class="p">]</span>

<span class="w">    </span><span class="c1">#Decode decode the network bytes slice to packet.Packet(s)</span>
<span class="w">    </span><span class="c1">## return null or [Packet]</span>
<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">Decode</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
<span class="w">        </span><span class="c1"># check length</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">HeadLength</span><span class="p">:</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;err header 0 &quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span>

<span class="w">        </span><span class="c1"># first time</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">HeadLength</span><span class="p">)</span>
<span class="w">        </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">HeadLength</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">HeadLength</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">[]</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParseHeader</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">:</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;err header 1 &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">header</span><span class="p">)))</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">typ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Packet</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">            </span><span class="n">p</span><span class="o">.</span><span class="n">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">typ</span>
<span class="w">            </span><span class="n">p</span><span class="o">.</span><span class="n">Length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span>
<span class="w">            </span><span class="n">packets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<span class="w">                </span><span class="n">p</span><span class="o">.</span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
<span class="w">                </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">[]</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">HeadLength</span><span class="p">:</span>
<span class="w">                </span><span class="k">break</span>
<span class="w">            </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">HeadLength</span><span class="p">)</span>
<span class="w">            </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">HeadLength</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">HeadLength</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">[]</span>
<span class="w">            </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParseHeader</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">:</span>
<span class="w">                </span><span class="k">break</span><span class="w"> </span>
<span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="w">            </span><span class="n">typ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">packets</span>

<span class="k">class</span><span class="w"> </span><span class="n">MessagesEncoder</span><span class="p">:</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">DataCompression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">compression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">routes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="c1">#压缩字典</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">codes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>

<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">SetDictionary</span><span class="p">(</span><span class="n">dict</span><span class="p">):</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">dict</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span>
<span class="w">        </span><span class="c1">#routesCodesMutex.Lock()</span>
<span class="w">        </span><span class="c1">#defer routesCodesMutex.Unlock()</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">route</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">dict</span><span class="p">:</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dict</span><span class="p">[</span><span class="n">route</span><span class="p">]</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">route</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="c1">#duplication check</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">routes</span><span class="p">:</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">codes</span><span class="p">:</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span>
<span class="w">            </span><span class="c1">#update map, using last value when key duplicated</span>
<span class="w">            </span><span class="n">routes</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">code</span>
<span class="w">            </span><span class="n">codes</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span>

<span class="w">    </span><span class="c1">#GetDictionary gets the routes map which is used to compress route.</span>
<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">GetDictionary</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">Dictionary</span><span class="p">:</span>
<span class="w">        </span><span class="c1">#routesCodesMutex.RLock()</span>
<span class="w">        </span><span class="c1">#defer routesCodesMutex.RUnlock()</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">dict</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">routes</span><span class="p">:</span>
<span class="w">            </span><span class="n">dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">routes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">dict</span>

<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">routable</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MSG_TYPE_REQUEST</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MSG_TYPE_NOTIFY</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MSG_TYPE_PUSH</span>

<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">invalidType</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MSG_TYPE_REQUEST</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MSG_TYPE_PUSH</span>

<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">Uint16</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">:</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">b1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFFFF</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">b2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">8</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">b1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">b2</span>

<span class="c1">#// Encode marshals message to binary format. Different message types is corresponding to</span>
<span class="c1">#// different message header, message types is identified by 2-4 bit of flag field. The</span>
<span class="c1">#// relationship between message types and message header is presented as follows:</span>
<span class="c1">#// ------------------------------------------</span>
<span class="c1">#// |   type   |  flag  |       other        |</span>
<span class="c1">#// |----------|--------|--------------------|</span>
<span class="c1">#// | request  |----000-|&lt;message id&gt;|&lt;route&gt;|</span>
<span class="c1">#// | notify   |----001-|&lt;route&gt;             |</span>
<span class="c1">#// | response |----010-|&lt;message id&gt;        |</span>
<span class="c1">#// | push     |----011-|&lt;route&gt;             |</span>
<span class="c1">#// ------------------------------------------</span>
<span class="c1">#// The figure above indicates that the bit does not affect the type of message.</span>
<span class="c1">#// See ref: https://github.com/topfreegames/pitaya/v2/blob/master/docs/communication_protocol.md</span>

<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">Encode</span><span class="p">(</span><span class="n">message</span><span class="p">:</span><span class="n">Message</span><span class="p">):</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">invalidType</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">Type</span><span class="p">):</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">buf</span><span class="p">:</span><span class="nb nb-Type">PackedByteArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">PackedByteArray</span><span class="p">()</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">Type</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span>

<span class="w">        </span><span class="c1">#routesCodesMutex.RLock()</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">compressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="o">.</span><span class="n">Route</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">routes</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">routes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">Route</span><span class="p">)</span>

<span class="w">        </span><span class="c1">#routesCodesMutex.RUnlock()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">compressed</span><span class="p">:</span>
<span class="w">            </span><span class="n">flag</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">MSG_MASK_MSGROUTECOMPRESS</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">message</span><span class="o">.</span><span class="n">Err</span><span class="p">:</span>
<span class="w">            </span><span class="n">flag</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">MSG_MASK_ERROR</span>

<span class="w">        </span><span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">message</span><span class="o">.</span><span class="n">Type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MSG_TYPE_REQUEST</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">message</span><span class="o">.</span><span class="n">Type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MSG_TYPE_RESPONSE</span><span class="p">:</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">n</span><span class="p">:</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="o">.</span><span class="n">ID</span>
<span class="w">            </span><span class="c1">#variant length encode</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="bp">true</span><span class="p">:</span>
<span class="w">                </span><span class="k">var</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span>
<span class="w">                </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mf">128.0</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<span class="w">                    </span><span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mi">128</span><span class="p">)</span>
<span class="w">                </span><span class="k">else</span><span class="p">:</span>
<span class="w">                    </span><span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="w">                    </span><span class="k">break</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">routable</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">Type</span><span class="p">):</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">compressed</span><span class="p">:</span>
<span class="w">                </span><span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">code</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xFF</span><span class="p">)</span>
<span class="w">                </span><span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="o">&amp;</span><span class="mh">0xFF</span><span class="p">)</span>
<span class="w">            </span><span class="k">else</span><span class="p">:</span>
<span class="w">                </span><span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">Route</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xFF</span><span class="p">)</span>
<span class="w">                </span><span class="n">buf</span><span class="o">.</span><span class="n">append_array</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">Route</span><span class="o">.</span><span class="n">to_utf8_buffer</span><span class="p">())</span>


<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">DataCompression</span><span class="p">:</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compression</span><span class="o">.</span><span class="n">DeflateData</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">Data</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">:</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">Data</span><span class="p">):</span>
<span class="w">                </span><span class="n">message</span><span class="o">.</span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span>
<span class="w">                </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">MSG_MASK_GZIP</span>

<span class="w">        </span><span class="n">buf</span><span class="o">.</span><span class="n">append_array</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">Data</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">buf</span>


<span class="w">    </span><span class="c1"># github.com/topfreegames/pitaya/v2@v2.11.21/conn</span>
<span class="w">    </span><span class="c1"># Decode unmarshal the bytes slice to a message</span>
<span class="w">    </span><span class="c1"># See ref: https://github.com/topfreegames/pitaya/v2/blob/master/docs/communication_protocol.md</span>
<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">Decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Message</span><span class="p">:</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MSG_MASK_MSGHEADLENGTH</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">m</span><span class="o">.</span><span class="n">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mh">0xFF</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MSG_MASK_MSGTYPE</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">invalidType</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Type</span><span class="p">):</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MSG_TYPE_REQUEST</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MSG_TYPE_RESPONSE</span><span class="p">:</span>
<span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="c1"># little end byte order</span>
<span class="w">            </span><span class="c1"># WARNING: must can be stored in 64 bits integer</span>
<span class="w">            </span><span class="c1"># variant length encode</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
<span class="w">                </span><span class="k">var</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">                </span><span class="n">id</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">(</span><span class="mi">7</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">offset</span><span class="p">));</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">128</span><span class="p">:</span>
<span class="w">                    </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                    </span><span class="k">break</span>

<span class="w">            </span><span class="c1">#var i = offset</span>
<span class="w">            </span><span class="c1">#while i &lt; len(data):</span>
<span class="w">                </span><span class="c1">#var b = data[i]</span>
<span class="w">                </span><span class="c1">#id += (b&amp;0x7F) * int(pow(2, (7 *i)))</span>
<span class="w">                </span><span class="c1">#if b &lt; 128:</span>
<span class="w">                    </span><span class="c1">#offset = i + 1</span>
<span class="w">                    </span><span class="c1">#break</span>
<span class="w">                </span><span class="c1">#i += 1 </span>

<span class="w">            </span><span class="n">m</span><span class="o">.</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span>

<span class="w">        </span><span class="n">m</span><span class="o">.</span><span class="n">Err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flag</span><span class="o">&amp;</span><span class="n">MSG_MASK_ERROR</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MSG_MASK_ERROR</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">routable</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Type</span><span class="p">):</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">flag</span><span class="o">&amp;</span><span class="n">MSG_MASK_MSGROUTECOMPRESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">                </span><span class="n">m</span><span class="o">.</span><span class="n">compressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span>
<span class="w">                </span><span class="k">var</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Uint16</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
<span class="w">                </span><span class="c1">#routesCodesMutex.RLock()</span>
<span class="w">                </span><span class="k">var</span><span class="w"> </span><span class="n">route</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">codes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">)</span>
<span class="w">                </span><span class="c1">#routesCodesMutex.RUnlock()</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">route</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">:</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span>

<span class="w">                </span><span class="n">m</span><span class="o">.</span><span class="n">Route</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">route</span>
<span class="w">                </span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">            </span><span class="k">else</span><span class="p">:</span>
<span class="w">                </span><span class="n">m</span><span class="o">.</span><span class="n">compressed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span>
<span class="w">                </span><span class="k">var</span><span class="w"> </span><span class="n">rl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span>
<span class="w">                </span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                </span><span class="k">var</span><span class="w"> </span><span class="n">valb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">(</span><span class="n">rl</span><span class="p">))</span>
<span class="w">                </span><span class="n">m</span><span class="o">.</span><span class="n">Route</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">valb</span><span class="o">.</span><span class="n">get_string_from_utf8</span><span class="p">()</span>
<span class="w">                </span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">(</span><span class="n">rl</span><span class="p">)</span>


<span class="w">        </span><span class="n">m</span><span class="o">.</span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">flag</span><span class="o">&amp;</span><span class="n">MSG_MASK_GZIP</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MSG_MASK_GZIP</span><span class="p">:</span>
<span class="w">            </span><span class="n">m</span><span class="o">.</span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compression</span><span class="o">.</span><span class="n">InflateData</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Data</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">Data</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">:</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb nb-Type">null</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m</span>

<span class="k">class</span><span class="w"> </span><span class="n">Compression</span><span class="p">:</span>
<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">DeflateData</span><span class="p">(</span><span class="n">_data</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">PackedByteArray</span><span class="p">:</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">PackedByteArray</span><span class="p">()</span>
<span class="w">        </span><span class="c1">#未实现</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bb</span>

<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">InflateData</span><span class="p">(</span><span class="n">_data</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">PackedByteArray</span><span class="p">:</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">bb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">PackedByteArray</span><span class="p">()</span>
<span class="w">        </span><span class="c1">#未实现</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bb</span>

<span class="w">    </span><span class="k">func</span><span class="w"> </span><span class="n">IsCompressed</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb nb-Type">bool</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="p">(</span>
<span class="w">            </span><span class="c1"># zlib</span>
<span class="w">            </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x78</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x9C</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x01</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xDA</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x5E</span><span class="p">))</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="c1">#gzip</span>
<span class="w">            </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x1F</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x8B</span><span class="p">))</span>
</code></pre></div>









  
  






  <h2 id="__comments">评论</h2>
  <!-- Insert generated snippet here -->
<script src="https://giscus.app/client.js"
        data-repo="hcqmaker/hcqmaker.github.io"
        data-repo-id="R_kgDORPLtTg"
        data-category="Announcements"
        data-category-id="DIC_kwDORPLtTs4C2alv"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
</script>
  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate"
        ? "transparent_dark"
        : "light"

      // Instruct Giscus to set theme
      giscus.setAttribute("data-theme", theme) 
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

          // Instruct Giscus to change theme
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2016 - 2030  Holmes
    </div>
  
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="mailto:<hcqmaker@gmail.com>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M536.4-26.3c9.8-3.5 20.6-1 28 6.3s9.8 18.2 6.3 28l-178 496.9c-5 13.9-18.1 23.1-32.8 23.1-14.2 0-27-8.6-32.3-21.7l-64.2-158c-4.5-11-2.5-23.6 5.2-32.6l94.5-112.4c5.1-6.1 4.7-15-.9-20.6s-14.6-6-20.6-.9l-112.4 94.3c-9.1 7.6-21.6 9.6-32.6 5.2L38.1 216.8c-13.1-5.3-21.7-18.1-21.7-32.3 0-14.7 9.2-27.8 23.1-32.8z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/hcqmaker" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      
      <script id="__config" type="application/json">{"annotate":null,"base":"../..","features":["navigation.instant","navigation.top","navigation.tracking","navigation.prune","navigation.path","navigation.indexes","toc.follow","search.highlight","search.share","search.suggest","content.code.copy","content.code.select","navigation.expand"],"search":"../../assets/javascripts/workers/search.e2d2d235.min.js","tags":null,"translations":{"clipboard.copied":"已复制","clipboard.copy":"复制","search.result.more.one":"在该页上还有 1 个符合条件的结果","search.result.more.other":"在该页上还有 # 个符合条件的结果","search.result.none":"没有找到符合条件的结果","search.result.one":"找到 1 个符合条件的结果","search.result.other":"# 个符合条件的结果","search.result.placeholder":"键入以开始搜索","search.result.term.missing":"缺少","select.version":"选择当前版本"},"version":null}</script>
    
    
      <script src="../../assets/javascripts/bundle.16f8adc2.min.js"></script>
      
    
  </body>
</html>